<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MessiahBot ‚Äî Dashboard</title>
  <link rel="preload" href="{{ url_for('static', filename='fonts/XLOELX.woff2') }}" as="font" type="font/woff2" crossorigin>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>
  <nav class="topnav">
    <div class="topnav__brand">MessiahBot</div>
    <div class="topnav__env">ENV: <strong>{{ env }}</strong></div>
  </nav>

  <main class="container">
    <section class="grid grid--3">
      <div class="card">
        <h2>Discord</h2>
        <p id="discordStatus" class="muted">Loading‚Ä¶</p>
        <div class="actions">
          <a class="btn btn--primary" href="/login">Login with Discord</a>
        </div>
      </div>

      <div class="card">
        <h2>Twitch</h2>

        <!-- Status message -->
        <p id="twitch-status" class="muted">Loading...</p>

        <!-- Connect button -->
        <div class="actions">
          <button id="connect-twitch" class="twitch-btn">üéÆ Connect Twitch</button>
        </div>
      </div>

      <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const btn = document.getElementById("connect-twitch");
        const status = document.getElementById("twitch-status");

        try {
          const resp = await fetch("/whoami/guild");
          const data = await resp.json();

          if (data.ok && data.guild_id) {
            btn.onclick = () => {
              window.location.href = `/connect/twitch/${data.guild_id}`;
          };
          status.textContent = "Ready to connect your Twitch account.";
        } else {
          btn.disabled = true;
          status.textContent = "Please log in with Discord first.";
        }
      } catch (e) {
        btn.disabled = true;
        status.textContent = "‚ö†Ô∏è Could not verify login state.";
        console.error("Guild lookup failed:", e);
      }
    });
    </script>


      <div class="card">
        <h2>Plex</h2>
        <p id="plexStatus" class="muted">Checking‚Ä¶</p>
        <div class="actions">
          <button class="btn" id="btnPlexCheck">Refresh Plex Status</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="card__hdr">
        <h2>Server Builder</h2>
        <div class="card__hdrActions">
          <button class="btn" id="btnLoadLive">Load from Live</button>
          <button class="btn btn--primary" id="btnSave">Save Layout</button>
        </div>
      </div>

      <div id="builderNote" class="muted">Choose a server and load its current layout, or edit and save.</div>

      <div class="formRow">
        <label for="guildId">Guild ID</label>
        <input id="guildId" type="text" placeholder="1408900348671824024">
      </div>

      <div class="grid grid--2">
        <div>
          <label>Categories/Channels (JSON)</label>
          <textarea id="layoutJson" rows="18" placeholder="{ /* structure will appear here after Load from Live */ }"></textarea>
        </div>
        <div>
          <label>Roles (JSON)</label>
          <textarea id="rolesJson" rows="18" placeholder="[ /* roles appear here after Load from Live */ ]"></textarea>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="footer__inner">
      <span>Environment:</span>
      <code>{{ env }}</code>
    </div>
  </footer>

<script>
function el(id){ return document.getElementById(id); }
function setStatus(id, text, ok=true){
  const node = el(id);
  node.textContent = text;
  node.className = ok ? "ok" : "err";
}

async function initStatuses(){
  try {
    const env = await fetch("/envcheck").then(r=>r.json());
    setStatus("discordStatus", env.discord ? "Connected" : "Not connected", !!env.discord);
    setStatus("twitchStatus", env.twitch ? "Connected" : "Not connected", !!env.twitch);

    const who = await fetch("/whoami").then(r=>r.json());
    if (who && who.plex_url){
      setStatus("plexStatus", "Configured", true);
    } else {
      setStatus("plexStatus", "Not configured", false);
    }
  } catch (e){
    console.error(e);
  }
}

el("btnPlexCheck").addEventListener("click", async () => {
  try{
    const r = await fetch("/plex/status").then(r=>r.json());
    if (r.ok){
      setStatus("plexStatus", "Plex reachable (code " + (r.status_code||200) + ")", true);
    } else {
      setStatus("plexStatus", "Plex error: " + (r.error || r.status_code), false);
    }
  }catch(e){
    setStatus("plexStatus", "Plex error: " + e.message, false);
  }
});

el("btnLoadLive").addEventListener("click", async () => {
  const gid = el("guildId").value.trim();
  if (!gid){ alert("Enter a Guild ID first"); return; }
  try{
    await fetch("/layout-config?guild_id=" + encodeURIComponent(gid)).then(r=>r.json());
    const data = await fetch("/api/live_layout/" + encodeURIComponent(gid)).then(r=>r.json());
    el("layoutJson").value = JSON.stringify(data.categories_channels || data, null, 2);
    el("rolesJson").value = JSON.stringify(data.roles || [], null, 2);
    el("builderNote").textContent = "Loaded live layout for guild " + gid;
  }catch(e){
    console.error(e);
    el("builderNote").textContent = "Failed to load from live: " + e.message;
  }
});

el("btnSave").addEventListener("click", async () => {
  const gid = el("guildId").value.trim();
  if (!gid){ alert("Enter a Guild ID first"); return; }
  let layout = {}, roles = [];
  try { layout = JSON.parse(el("layoutJson").value || "{}"); } catch(e){ return alert("Layout JSON invalid"); }
  try { roles  = JSON.parse(el("rolesJson").value  || "[]"); } catch(e){ return alert("Roles JSON invalid"); }

  const payload = { guild_id: gid, layout, roles };
  const resp = await fetch("/submit-server-layout", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  if (resp.ok){
    el("builderNote").textContent = "Saved layout for guild " + gid;
  } else {
    const t = await resp.text();
    el("builderNote").textContent = "Save failed: " + t;
  }
});

initStatuses();
</script>
</body>
</html>
