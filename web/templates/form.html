<script>
function el(id){ return document.getElementById(id); }

function setStatus(id, text, ok=true){
  const node = el(id);
  node.textContent = text;
  node.className = ok ? "ok" : "err";
}

async function loadStatuses(){
  try {
    //
    // 1️⃣ Check who is logged in (Discord session)
    //
    const who = await fetch("/whoami").then(r=>r.json());

    if (who.logged_in) {
      setStatus("discordStatus", `Logged in as ${who.user.username}`, true);

      // Hide Login button
      const loginBtn = document.querySelector('a[href="/login"]');
      if (loginBtn) loginBtn.style.display = "none";

      // Auto-fill Guild ID with the first guild you OWN
      const owned = (who.guild_count > 0 && who.guilds) 
        ? who.guilds.filter(g => g.owner)
        : [];
      
      if (owned.length > 0) {
        el("guildId").value = owned[0].id;
      }

    } else {
      setStatus("discordStatus", "Not logged in", false);
    }

    //
    // 2️⃣ Twitch Connection Status
    //
    const env = await fetch("/envcheck").then(r=>r.json());
    setStatus("twitchStatus