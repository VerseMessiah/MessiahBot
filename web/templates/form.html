<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MessiahBot — Dashboard</title>
  <link rel="preload" href="{{ url_for('static', filename='fonts/XLOELX.woff2') }}" as="font" type="font/woff2" crossorigin>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>
  <nav class="topnav">
    <div class="topnav__brand">MessiahBot</div>
    <div class="topnav__env">ENV: <strong>{{ env }}</strong></div>
  </nav>

  <main class="container">
    <section class="grid grid--3">
      <div class="card">
        <h2>Discord</h2>
        <p id="discordStatus" class="muted">Loading…</p>
        <div class="actions">
          <a class="btn btn--primary" href="/login">Login with Discord</a>
        </div>
      </div>

      <div class="card">
        <h2>Twitch</h2>
        <p id="twitchStatus" class="muted">Loading…</p>
        <div class="actions">
          <a class="btn" href="/connect_twitch">Connect Twitch</a>
        </div>
      </div>

      <div class="card">
        <h2>Plex</h2>
        <p id="plexStatus" class="muted">Checking…</p>
        <div class="actions">
          <button class="btn" id="btnPlexCheck">Refresh Plex Status</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="card__hdr">
        <h2>Server Builder</h2>
        <div class="card__hdrActions">
          <button class="btn" id="btnLoadLive" disabled>Load from Live</button>
          <button class="btn" id="btnLoadSnapshot" disabled>Load Snapshot</button>
          <button class="btn btn--primary" id="btnSave" disabled>Save Layout</button>
        </div>
      </div>

      <div id="builderNote" class="muted">Choose a server and load its current layout, or edit and save.</div>

      <div class="formRow">
        <label for="guildSelect">Select Server</label>
        <select id="guildSelect">
          <option value="">— Select a server —</option>
        </select>
      </div>

      <div class="flex-column" style="display: flex; flex-direction: column; gap: 1.5rem;">
        <div>
          <label>Roles (JSON)</label>
          <textarea id="rolesJson" rows="18" placeholder="[ /* roles appear here after Load from Live */ ]"></textarea>
        </div>
        <div>
          <label>Categories/Channels (JSON)</label>
          <textarea id="layoutJson" rows="18" placeholder="{ /* structure will appear here after Load from Live */ }"></textarea>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="footer__inner">
      <span>Environment:</span>
      <code>{{ env }}</code>
    </div>
  </footer>

<script>
function el(id){ return document.getElementById(id); }

const guildSelect = document.getElementById("guildSelect");
const btnLoadLive = document.getElementById("btnLoadLive");
const btnLoadSnapshot = document.getElementById("btnLoadSnapshot");
const btnSave = document.getElementById("btnSave");

guildSelect.addEventListener("change", () => {
  const has = !!guildSelect.value.trim();
  btnLoadLive.disabled = !has;
  btnLoadSnapshot.disabled = !has;
  btnSave.disabled = !has;
});

function setStatus(id, text, ok=true){
  const node = el(id);
  node.textContent = text;
  node.className = ok ? "ok" : "err";
}

async function loadStatuses(){
  try {
    const who = await fetch("/whoami").then(r=>r.json());

    if (who.logged_in) {
      setStatus("discordStatus", `Logged in as ${who.user.username}`, true);
      const loginBtn = document.querySelector('a[href="/login"]');
      if (loginBtn) loginBtn.style.display = "none";
      if (who.guilds){
        guildSelect.innerHTML = '<option value="">— Select a server —</option>';
        for (const g of who.guilds){
          const opt = document.createElement("option");
          opt.value = g.id;
          opt.textContent = g.name + (g.owner ? " (owner)" : "");
          guildSelect.appendChild(opt);
        }
      }
    } else {
      setStatus("discordStatus", "Not logged in", false);
    }

    const env = await fetch("/envcheck").then(r=>r.json());
    setStatus("twitchStatus", env.twitch ? "Connected" : "Not connected", !!env.twitch);

    const plexResp = await fetch("/plex/status").then(r => r.json());
    if (plexResp.ok) {
      setStatus("plexStatus", "Plex reachable", true);
    } else {
      setStatus("plexStatus", "Not configured or unreachable", false);
    }
  } catch (e){
    console.error("Status init error:", e);
  }
}

el("btnPlexCheck").addEventListener("click", async () => {
  try {
    const r = await fetch("/plex/status").then(r=>r.json());
    if (r.ok){
      setStatus("plexStatus", "Plex reachable (code " + (r.status_code || 200) + ")", true);
    } else {
      setStatus("plexStatus", "Plex error: " + (r.error || r.status_code), false);
    }
  }catch(e){
    setStatus("plexStatus", "Plex error: " + e.message, false);
  }
});

el("btnLoadLive").addEventListener("click", async () => {
  const gid = guildSelect.value.trim();
  if (!gid){ alert("Select a server first"); return; }

  try {
    await fetch("/layout-config?guild_id=" + encodeURIComponent(gid));

    const data = await fetch("/api/live_layout/" + encodeURIComponent(gid))
      .then(r=>r.json());

    el("layoutJson").value = JSON.stringify(
      data.categories_channels || data,
      null,
      2
    );
    el("rolesJson").value = JSON.stringify(data.roles || [], null, 2);
    el("builderNote").textContent = "Loaded live layout for guild " + gid;

  } catch (e){
    console.error(e);
    el("builderNote").textContent = "Failed to load from live: " + e.message;
  }
});

document.getElementById("btnLoadSnapshot").addEventListener("click", async () => {
  const gid = guildSelect.value.trim();
  if (!gid){ alert("Select a server first"); return; }
  try {
    const snap = await fetch("/api/snapshot/" + encodeURIComponent(gid)).then(r=>r.json());
    if (!snap || !snap.layout){ 
      el("builderNote").textContent = "No snapshot found."; 
      return;
    }
    el("layoutJson").value = JSON.stringify(snap.layout, null, 2);
    el("rolesJson").value = JSON.stringify(snap.roles || [], null, 2);
    el("builderNote").textContent = "Loaded snapshot for guild " + gid;
  } catch(e){
    el("builderNote").textContent = "Snapshot load failed: " + e.message;
  }
});

el("btnSave").addEventListener("click", async () => {
  const gid = guildSelect.value.trim();
  if (!gid){ alert("Select a server first"); return; }

  let layout = {}, roles = [];
  try { layout = JSON.parse(el("layoutJson").value || "{}"); } 
  catch(e){ return alert("Layout JSON is invalid"); }

  try { roles = JSON.parse(el("rolesJson").value || "[]"); } 
  catch(e){ return alert("Roles JSON is invalid"); }

  const payload = { guild_id: gid, layout, roles };

  const resp = await fetch("/submit-server-layout", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (resp.ok){
    el("builderNote").textContent = "Saved layout for guild " + gid;
  } else {
    const t = await resp.text();
    el("builderNote").textContent = "Save failed: " + t;
  }
});

loadStatuses();
</script>

</body>
</html>